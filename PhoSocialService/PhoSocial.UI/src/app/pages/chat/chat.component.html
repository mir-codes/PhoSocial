<audio id="msg-audio" src="/assets/NotificationSounds/MessageRecived.mp3" preload="auto" style="display:none"></audio>

<div class="messages-container">
    <!-- Users List -->
    <div class="chat-user-list">
        <div *ngFor="let u of chatUsers" class="chat-user-item neu-element" (click)="openConversationWithUser(u.otherUserId ?? u.id)">
            <div class="user-avatar neu-element">
                <img [src]="u.otherProfileImageUrl || u.profileImageUrl || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150'" alt="user">
            </div>
            <div style="flex: 1;">
                <h4 class="user-name">{{ u.otherUsername || u.username || u.name || u.id }}</h4>
                <p style="font-size: 0.85rem; color: #a3b1c6;">{{ u.lastMessage || '' }}</p>
            </div>
            <span *ngIf="u.unread" class="notification-badge">{{ u.unread }}</span>
        </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window">
        <div class="chat-header neu-element" style="margin-bottom: var(--spacing-md);">
            <div class="post-user-info">
                <div class="user-avatar neu-element">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150" alt="Alex">
                </div>
                <div class="user-details">
                    <h3 class="user-name color-blue">Alex Chen</h3>
                    <span class="post-time">Active now</span>
                </div>
            </div>
            <button class="post-menu-btn neu-element">⋯</button>
        </div>

        <div #messagesContainer style="flex: 1; overflow-y: auto; padding: var(--spacing-md) 0;" (scroll)="onMessagesScroll($event)">
            <div *ngIf="loadingMore" style="text-align:center; padding:8px;">Loading...</div>
            <div *ngFor="let m of messages.slice().reverse()" [ngClass]="{'message-bubble': true, 'sent': m.senderId == auth.getUserIdFromToken(), 'received': m.senderId != auth.getUserIdFromToken()}">
                <span>{{ m.messageText || m.content }}</span>
                <div class="message-meta">{{ m.createdAt | date:'short' }}</div>
            </div>
        </div>

        <div style="padding: var(--spacing-md) 0; border-top: 1px solid rgba(163, 177, 198, 0.2);">
            <div class="search-box neu-inset" style="margin: 0; display:flex; gap:8px; align-items:center;">
                <input [(ngModel)]="text" (keydown.enter)="send()" type="text" placeholder="Type a message..." class="search-input" style="font-size: 1rem; flex:1;">
                <button (click)="send()" class="neu-element" style="width: 44px; height: 44px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border-radius: var(--radius-full);">
                    ➤
                </button>
            </div>
        </div>
    </div>
